datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Core user - linked to Solana wallet
model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique // Solana wallet = identity
  email         String?  @unique // Optional, for notifications
  username      String?  @unique // Display name
  avatarUrl     String?
  bio           String?
  role          String   @default("listener") // "listener" | "artist" | "admin"
  
  // Token holdings (cached, synced from chain)
  tokenBalance  Float    @default(0)
  tier          String   @default("free") // "free" | "holder" | "premium" | "whale"
  
  // Stats
  totalPlays    Int      @default(0)
  totalStaked   Float    @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastSeenAt    DateTime @default(now())

  // Relations
  artist        Artist?
  plays         Play[]
  stakes        Stake[]
  following     Follow[]  @relation("follower")
  followers     Follow[]  @relation("following")
  likes         Like[]
  playlists     Playlist[]
  comments      Comment[]
  
  // Messaging relations
  conversations     ConversationParticipant[]
  sentMessages      Message[] @relation("MessageSender")
  receivedMessages  Message[] @relation("MessageRecipient")
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  earlyAccessLists  EarlyAccess[]
  purchases         Purchase[]
}

// Artist profile - extends User
model Artist {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile
  name            String
  bio             String?
  avatarUrl       String?
  bannerUrl       String?
  location        String?
  genre           String?
  wallet          String?  // Artist's Solana wallet
  
  // Social links (JSON string)
  links           String?  // {"twitter": "...", "instagram": "...", "website": "..."}
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  stakeAmount     Float    @default(0) // Tokens staked for verification
  
  // Artist Token (SPL Token)
  tokenMint       String?  @unique // Artist's SPL token mint address
  tokenSymbol     String?  // e.g. "$ARTIST"
  tokenName       String?  // e.g. "Artist Fan Token"
  
  // Stats (denormalized for performance)
  totalTracks     Int      @default(0)
  totalPlays      Int      @default(0)
  totalFollowers  Int      @default(0)
  totalRevenue    Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tracks          Track[]
  broadcasts      Broadcast[]
  earlyAccessList EarlyAccess[]
}

// Music tracks
model Track {
  id              String   @id @default(cuid())
  artistId        String
  artist          Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  // Metadata
  title           String
  ticker          String   // e.g. "$LOFI-TKY"
  description     String?
  genre           String?
  bpm             Int?
  duration        Int?     // seconds
  
  // Audio Files (cloud storage)
  audioUrl        String?  // Original upload URL (private)
  audioKey        String?  // Storage key for the audio file
  audioFormat     String?  // "mp3" | "wav" | "flac"
  audioSize       Int?     // File size in bytes
  streamUrl       String?  // HLS/DASH manifest URL (for streaming)
  previewUrl      String?  // 30-second preview URL
  
  // Cover art
  coverUrl        String?  // Cover image URL
  coverKey        String?  // Storage key for cover
  
  // Waveform
  waveformData    String?  // JSON array for waveform visualization
  waveformUrl     String?  // Pre-rendered waveform image
  
  // Location
  region          String?  // "TOKYO, JP"
  coordinates     String?  // "35.6762° N, 139.6503° E"
  latitude        Float?
  longitude       Float?
  
  // Token gating
  gateType        String   @default("none") // "none" | "token" | "nft" | "paid"
  gateTokenMint   String?  // Required token mint address
  gateTokenAmount Float?   // Required token amount
  gateNftCollection String? // Required NFT collection
  priceSOL        Float?   // Price in SOL (if paid)
  priceToken      Float?   // Price in $IXXXI (if paid)
  
  // Stats
  playCount       Int      @default(0)
  uniquePlays     Int      @default(0)  // Unique listeners
  likeCount       Int      @default(0)
  stakeCount      Float    @default(0) // Total tokens staked on this track
  skipRate        Float?   // % of plays that skip before 30s
  avgPlayDuration Float?   // Average listen duration in seconds
  
  // Revenue
  totalRevenue    Float    @default(0)
  
  // NFT / Web3
  nftMint         String?  @unique // NFT mint address for this track
  nftMetadataUri  String?  // URI to NFT metadata (Arweave/IPFS)
  royaltySplits   Json?    // Royalty distribution: [{wallet, percentage, role}]
  price           Float?   // Price in USD for purchase
  releaseDate     DateTime?
  sales           Int      @default(0) // Number of purchases
  
  // Status
  status          String   @default("processing") // "processing" | "ready" | "published" | "scheduled" | "archived" | "failed"
  processingError String?  // Error message if processing failed
  publishedAt     DateTime?
  
  // Early access / Scheduling
  scheduledReleaseAt DateTime? // Public release date
  earlyAccessDays    Int?      // Days before release for premium users
  
  // Exclusive content
  isExclusive     Boolean  @default(false)
  requiredTier    String?  // "free" | "holder" | "premium" | "whale"
  
  // Lossless audio
  losslessUrl     String?  // FLAC file URL for premium
  losslessKey     String?  // Storage key for FLAC file
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  plays           Play[]
  stakes          Stake[]
  likes           Like[]
  playlistTracks  PlaylistTrack[]
  purchases       Purchase[]
  comments        Comment[]
  downloads       Download[]
  
  @@index([artistId])
  @@index([status])
  @@index([genre])
  @@index([playCount])
}

// Play history - for analytics and royalty calculations
model Play {
  id              String   @id @default(cuid())
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Play data
  duration        Int      @default(0) // How long they listened (seconds)
  completed       Boolean  @default(false) // Did they finish the track?
  
  // Context
  source          String?  // "feed" | "search" | "playlist" | "direct"
  
  // Location (anonymized)
  region          String?
  
  createdAt       DateTime @default(now())
  
  @@index([trackId, createdAt])
  @@index([userId, createdAt])
}

// Curation stakes - users bet on tracks
model Stake {
  id              String   @id @default(cuid())
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount          Float    // Tokens staked
  
  // Rewards (calculated periodically)
  rewardsEarned   Float    @default(0)
  rewardsClaimed  Float    @default(0)
  
  // On-chain reference
  txSignature     String?  // Solana transaction signature
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([trackId, userId])
  @@index([userId])
}

// Social: Follows
model Follow {
  id              String   @id @default(cuid())
  followerId      String
  follower        User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId     String
  following       User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followingId])
}

// Social: Likes
model Like {
  id              String   @id @default(cuid())
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@unique([trackId, userId])
  @@index([userId])
}

// Playlists
model Playlist {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  coverUrl        String?
  isPublic        Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tracks          PlaylistTrack[]
}

model PlaylistTrack {
  id              String   @id @default(cuid())
  playlistId      String
  playlist        Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  position        Int
  
  addedAt         DateTime @default(now())
  
  @@unique([playlistId, trackId])
  @@index([playlistId])
}

// Platform analytics (aggregated)
model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  
  totalPlays      Int      @default(0)
  uniqueListeners Int      @default(0)
  newUsers        Int      @default(0)
  newArtists      Int      @default(0)
  newTracks       Int      @default(0)
  totalStaked     Float    @default(0)
  totalRevenue    Float    @default(0)
  
  // Top content (JSON)
  topTracks       String?  // JSON array of track IDs
  topArtists      String?  // JSON array of artist IDs
  
  createdAt       DateTime @default(now())
}

// Track purchases
model Purchase {
  id              String   @id @default(cuid())
  buyerId         String   // Buyer user ID
  buyer           User     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  
  amount          Float    // Price paid
  currency        String   // "SOL" | "USDC" | "TOKEN"
  txSignature     String   @unique // Solana transaction signature
  status          String   @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED"
  
  // Royalty distribution
  artistAmount    Float?   // Amount sent to artist
  platformFee     Float?   // Platform fee
  royaltySplits   Json?    // Actual distribution breakdown
  
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  
  @@index([buyerId])
  @@index([trackId])
  @@index([txSignature])
}

// Transaction records (for history)
model Transaction {
  id              String   @id @default(cuid())
  wallet          String   // User wallet
  signature       String   @unique // Solana tx signature
  type            String   // "purchase" | "transfer" | "nft_mint" | "stake" | "royalty"
  
  amount          Float?
  currency        String?  // "SOL" | "USDC" | token symbol
  
  // Related entities
  trackId         String?
  artistId        String?
  purchaseId      String?
  
  // Metadata
  metadata        Json?    // Additional context
  
  status          String   @default("confirmed") // "pending" | "confirmed" | "failed"
  blockTime       DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([wallet])
  @@index([type])
  @@index([trackId])
}

// Track comments
model Comment {
  id              String   @id @default(cuid())
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content         String   // Comment text (max 500 chars)
  timestamp       String?  // Optional timestamp in track (e.g., "1:23")
  
  // For replies
  parentId        String?
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  likeCount       Int      @default(0)
  isEdited        Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([trackId, createdAt])
  @@index([userId])
  @@index([parentId])
}

// Offline downloads
model Download {
  id              String   @id @default(cuid())
  userId          String
  trackId         String
  track           Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  
  quality         String   // "320kbps" | "FLAC"
  fileSize        Int?     // Size in bytes
  expiresAt       DateTime // Download link expiration
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([trackId])
}

// Conversations for messaging
model Conversation {
  id              String   @id @default(cuid())
  type            String   @default("direct") // "direct" | "group" | "broadcast"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  participants    ConversationParticipant[]
  messages        Message[]
}

model ConversationParticipant {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Mute / notification settings
  isMuted         Boolean  @default(false)
  lastReadAt      DateTime?
  
  joinedAt        DateTime @default(now())
  
  @@unique([conversationId, userId])
  @@index([userId])
}

// Direct messages
model Message {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId        String
  sender          User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipientId     String?  // For direct messages
  recipient       User?    @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  
  content         String   // Message text (max 2000 chars)
  
  // Attachments (JSON)
  attachments     String?  // [{type: "track", id: "..."}, {type: "image", url: "..."}]
  
  readAt          DateTime?
  editedAt        DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([recipientId])
}

// Artist broadcast messages
model Broadcast {
  id              String   @id @default(cuid())
  artistId        String
  artist          Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  title           String?
  content         String   // Message content
  audience        String   // "all" | "token_holders" | "premium" | "early_access"
  
  // Call to action
  actionUrl       String?
  actionLabel     String?
  
  recipientCount  Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([artistId, createdAt])
}

// User notifications (in-app)
model Notification {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            String   // "broadcast" | "new_release" | "follow" | "like" | "comment" | "earnings" | "system"
  title           String
  message         String
  
  // Extra data (JSON)
  data            String?  // {artistId, trackId, actionUrl, etc.}
  
  isRead          Boolean  @default(false)
  readAt          DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

// Push notification subscriptions
model PushSubscription {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint        String   @unique
  p256dh          String   // encryption key
  auth            String   // auth secret
  
  // Device info
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
}

// Early access list for artists
model EarlyAccess {
  id              String   @id @default(cuid())
  artistId        String
  artist          Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@unique([artistId, userId])
  @@index([artistId])
}
